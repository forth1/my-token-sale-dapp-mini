<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>MyToken 发售 DApp - Base</title>
  <!-- ethers.js v6 UMD 版本 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 16px;
    }
    .card {
      width: 420px;
      max-width: 100%;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 22px 22px 26px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.18), transparent 55%);
      pointer-events: none;
      z-index: 0;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }
    .badge-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 11px;
      color: #9ca3af;
    }
    .badge {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.22);
      border: 1px solid rgba(45, 212, 191, 0.4);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }
    .label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .input {
      width: 100%;
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1e293b;
      padding: 10px 12px;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      margin-bottom: 14px;
    }
    .input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }
    .btn {
      width: 100%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      border-radius: 999px;
      padding: 11px 0;
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      margin-bottom: 10px;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.08s;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45);
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34, 197, 94, 0.55);
    }
    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(34, 197, 94, 0.35);
    }
    .btn:disabled {
      background: #4b5563;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.7;
    }
    .btn-secondary {
      width: 100%;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 9px 0;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-secondary span.wallet-list {
      font-size: 11px;
      color: #9ca3af;
    }
    .row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 4px;
      color: #9ca3af;
    }
    .row-strong {
      font-weight: 500;
      color: #e5e7eb;
    }
    .accent {
      color: #22c55e;
      font-weight: 600;
    }
    .status {
      font-size: 12px;
      margin-top: 6px;
      color: #f97316;
      min-height: 16px;
      word-break: break-all;
    }
    .status.ok {
      color: #22c55e;
    }
    .status.error {
      color: #fb7185;
    }
    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
      line-height: 1.5;
    }
    .divider {
      height: 1px;
      background: #1f2937;
      margin: 14px 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-inner">
      <div class="badge-row">
        <div class="badge">
          <span class="badge-dot"></span>
          <span id="networkLabel">Base 主网</span>
        </div>
        <div style="opacity:0.8;">
          合约网络仅支持 EVM 钱包
        </div>
      </div>

      <div class="title">MyToken 发售</div>
      <div class="subtitle">
        使用任何支持 EVM 的浏览器钱包（MetaMask / OKX / Bitget / 币安 等）在
        <strong>Base 主网</strong> 用 ETH 购买 MTK 代币。
      </div>

      <button id="connectBtn" class="btn-secondary">
        连接钱包
        <span class="wallet-list">支持：MetaMask / OKX / Bitget / 币安 等</span>
      </button>

      <div class="row">
        <span>当前账号</span>
        <span id="accountLabel">未连接</span>
      </div>
      <div class="row">
        <span>钱包 ETH 余额</span>
        <span id="ethBalance">-</span>
      </div>
      <div class="row">
        <span>我的 MTK 余额</span>
        <span id="userTokenBalance">-</span>
      </div>

      <div class="divider"></div>

      <div class="row row-strong">
        <span>发售合约可售 MTK</span>
        <span id="saleBalance">-</span>
      </div>
      <div class="row">
        <span>兑换比例</span>
        <span id="rateInfo">-</span>
      </div>

      <div class="divider"></div>

      <div class="label">支付 ETH 数量</div>
      <input id="ethAmount" class="input" placeholder="例如：0.0001" />

      <button id="buyBtn" class="btn" disabled>买入 MTK</button>

      <div class="status" id="status"></div>
      <div class="small">
        ⚠️ 提示：<br />
        · 本页面仅为你当前这组合约：Base 主网<br />
        · 代币合约：<code>0x2Ab6...E2Ac</code><br />
        · 发售合约：<code>0x6E08...362c</code><br />
        · 请确认浏览器钱包已切换到 <strong>Base Mainnet</strong>，否则无法正常购买。
      </div>
    </div>
  </div>

  <script>
    // ========= 你的合约固定配置（可以按需要改） =========
    // 代币合约地址（MyToken）
    const TOKEN_CONTRACT_ADDRESS = "0x2Ab62247Ec58214137E2637a168ABcCB0A1AE2Ac";
    // 发售合约地址（MyTokenSale）
    const SALE_CONTRACT_ADDRESS = "0x6E083A917Aea75Ac27bB07Aec927aAA6590c362c";

    // Base 主网 chainId（十六进制 0x2105）
    const BASE_MAINNET_CHAIN_ID = 8453;

    // 发售合约 ABI：只写会用到的函数
    const SALE_ABI = [
      "function rate() view returns (uint256)",
      "function tokenBalance() view returns (uint256)",
      "function buyTokens() external payable"
    ];

    // TOKEN 合约 ABI：只写会用到的函数
    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)"
    ];

    let provider;
    let signer;
    let saleContract;
    let tokenContract;
    let currentAccount;
    let tokenDecimals = 18;
    let tokenSymbol = "MTK";

    const connectBtn = document.getElementById("connectBtn");
    const buyBtn = document.getElementById("buyBtn");
    const statusEl = document.getElementById("status");
    const accountLabel = document.getElementById("accountLabel");
    const saleBalanceEl = document.getElementById("saleBalance");
    const rateInfoEl = document.getElementById("rateInfo");
    const ethBalanceEl = document.getElementById("ethBalance");
    const userTokenBalanceEl = document.getElementById("userTokenBalance");
    const networkLabel = document.getElementById("networkLabel");

    function setStatus(msg, type = "") {
      statusEl.className = "status";
      if (type === "ok") statusEl.classList.add("ok");
      if (type === "error") statusEl.classList.add("error");
      statusEl.textContent = msg || "";
    }

    function shortAddr(addr) {
      if (!addr) return "";
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    // 尝试获取 EVM provider（支持多种浏览器钱包）
    function getInjectedProvider() {
      if (window.ethereum && window.ethereum.providers && window.ethereum.providers.length) {
        // 有些浏览器会有多个 provider（MetaMask + OKX 等）
        // 这里简单按常见钱包做个排序挑一个
        const providers = window.ethereum.providers;
        const priority = ["isMetaMask", "isOkxWallet", "isBitKeep", "isTokenPocket", "isBraveWallet"];
        for (const flag of priority) {
          const p = providers.find((pr) => pr[flag]);
          if (p) return p;
        }
        return providers[0];
      }

      // 单 provider 情况，MetaMask / OKX / 币安 等都会暴露这个
      if (window.ethereum) {
        return window.ethereum;
      }

      // 某些 OKX 的老版本可能挂在 window.okxwallet
      if (window.okxwallet && window.okxwallet.ethereum) {
        return window.okxwallet.ethereum;
      }

      return null;
    }

    async function ensureBaseNetwork(evmProvider) {
      try {
        const chainIdHex = await evmProvider.request({ method: "eth_chainId" });
        const chainId = parseInt(chainIdHex, 16);

        if (chainId === BASE_MAINNET_CHAIN_ID) {
          networkLabel.textContent = "Base 主网 ✅";
          return true;
        }

        networkLabel.textContent = "非 Base 主网 ⚠️";

        // 尝试请求切换到 Base 主网
        try {
          await evmProvider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x2105" }] // 8453
          });
          networkLabel.textContent = "Base 主网 ✅";
          return true;
        } catch (switchErr) {
          console.warn("切换网络失败：", switchErr);
          setStatus("请在钱包中手动切换到 Base 主网再重试。", "error");
          return false;
        }
      } catch (err) {
        console.error("检测网络失败：", err);
        setStatus("无法检测当前网络，请检查钱包。", "error");
        return false;
      }
    }

    // 连接钱包
    connectBtn.addEventListener("click", async () => {
      try {
        const injected = getInjectedProvider();
        if (!injected) {
          alert("没有检测到 EVM 浏览器钱包，请先安装 MetaMask / OKX / 币安 等钱包扩展。");
          return;
        }

        // 确保在 Base 网络
        const ok = await ensureBaseNetwork(injected);
        if (!ok) return;

        // ethers v6 的 BrowserProvider 直接包一层 EIP-1193 provider
        provider = new ethers.BrowserProvider(injected);
        const accounts = await injected.request({ method: "eth_requestAccounts" });
        currentAccount = accounts[0];

        signer = await provider.getSigner();
        saleContract = new ethers.Contract(SALE_CONTRACT_ADDRESS, SALE_ABI, signer);
        tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);

        accountLabel.textContent = shortAddr(currentAccount);
        connectBtn.textContent = "钱包已连接";
        buyBtn.disabled = false;
        setStatus("");

        // 监听账号/网络变化
        injected.on && injected.on("accountsChanged", (accs) => {
          if (accs && accs.length > 0) {
            currentAccount = accs[0];
            accountLabel.textContent = shortAddr(currentAccount);
            refreshInfo();
          } else {
            currentAccount = null;
            accountLabel.textContent = "未连接";
            buyBtn.disabled = true;
          }
        });
        injected.on && injected.on("chainChanged", () => {
          // 网络变更后刷新一下
          window.location.reload();
        });

        // 初始化 token 信息 + 各种余额
        await initTokenInfo();
        await refreshInfo();
      } catch (err) {
        console.error(err);
        setStatus("连接钱包失败：" + (err?.message || err), "error");
      }
    });

    async function initTokenInfo() {
      try {
        if (!tokenContract) return;
        tokenDecimals = await tokenContract.decimals();
        tokenSymbol = await tokenContract.symbol();
      } catch (err) {
        console.warn("读取 token decimals/symbol 失败，使用默认 18 / MTK", err);
      }
    }

    // 刷新 rate / tokenBalance / 账户余额等
    async function refreshInfo() {
      try {
        if (!saleContract || !provider) return;

        const [rate, balanceInSale] = await Promise.all([
          saleContract.rate(),
          saleContract.tokenBalance()
        ]);

        const rateReadable = ethers.formatUnits(rate, tokenDecimals); // 1 ETH = ? MTK
        const saleBalanceReadable = ethers.formatUnits(balanceInSale, tokenDecimals);

        rateInfoEl.textContent = `1 ETH = ${rateReadable} ${tokenSymbol}`;
        saleBalanceEl.textContent = `${saleBalanceReadable} ${tokenSymbol}`;

        // 钱包 ETH 余额
        if (currentAccount) {
          const ethBal = await provider.getBalance(currentAccount);
          ethBalanceEl.textContent = ethers.formatEther(ethBal) + " ETH";
        }

        // 用户 MTK 余额
        if (currentAccount && tokenContract) {
          const userTokenBal = await tokenContract.balanceOf(currentAccount);
          userTokenBalanceEl.textContent =
            ethers.formatUnits(userTokenBal, tokenDecimals) + " " + tokenSymbol;
        }
      } catch (err) {
        console.error(err);
        setStatus("读取合约信息失败：" + (err?.message || err), "error");
      }
    }

    // 购买代币
    buyBtn.addEventListener("click", async () => {
      try {
        if (!saleContract || !signer || !provider) {
          alert("请先连接钱包");
          return;
        }

        const ethStr = document.getElementById("ethAmount").value.trim();
        if (!ethStr) {
          alert("请输入要支付的 ETH 数量");
          return;
        }

        const value = ethers.parseEther(ethStr); // 把 "0.0001" 转成 Wei

        setStatus("发送交易中，请在钱包里确认...", "");
        buyBtn.disabled = true;

        const tx = await saleContract.buyTokens({ value });
        setStatus("链上确认中，等待打包（Tx: " + tx.hash.slice(0, 10) + "…）", "");

        await tx.wait();
        setStatus("购买成功 ✅ 你可以在钱包里查看 MTK 余额。", "ok");

        await refreshInfo();
        buyBtn.disabled = false;
      } catch (err) {
        console.error(err);
        buyBtn.disabled = false;
        if (err?.code === "ACTION_REJECTED") {
          setStatus("你在钱包里取消了这笔交易。", "error");
        } else {
          setStatus("交易失败：" + (err?.reason || err?.message || err), "error");
        }
      }
    });
  </script>
</body>
</html>